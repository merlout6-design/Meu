<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fritzza - Delivery</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Chewy&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .font-chewy { font-family: 'Chewy', cursive; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animations */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        /* Custom UI */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); }
        .product-card { transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .product-card:active { transform: scale(0.98); }
        
        /* Flying Image Animation */
        .flying-img { position: fixed; z-index: 10000; pointer-events: none; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        
        /* Status Tracker Steps */
        .step-line { position: absolute; left: 24px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; z-index: 0; }
        .step-item { position: relative; z-index: 1; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); display: flex; align-items: center; justify-content: center; z-index: 9999; animation: fadeIn 0.2s; }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes popIn { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURAÃ‡ÃƒO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAg2kfoWsvWWyEXQGe8v6jZZqKepgButUk",
            authDomain: "ajuda-2217b.firebaseapp.com",
            projectId: "ajuda-2217b",
            storageBucket: "ajuda-2217b.firebasestorage.app",
            messagingSenderId: "421083897636",
            appId: "1:421083897636:web:18bd6097b5c0169427ddb1"
        };

        if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) {} }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = "ajuda-2217b"; 
        const getCol = (n) => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(n);

        const { useState, useEffect, useMemo } = React;
        const formatMoney = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const DEFAULT_COORDS = { lat: -25.0015570, lng: -53.4628300 };
        const WHATSAPP_NUMBER = "5545988166885";

        // --- UTILITÃRIOS ---
        const isStoreOpen = (start, end) => {
            if(!start || !end) return true; 
            const now = new Date();
            const current = now.getHours() * 60 + now.getMinutes();
            const [sH, sM] = start.split(':').map(Number);
            const [eH, eM] = end.split(':').map(Number);
            const startMin = sH * 60 + sM;
            const endMin = eH * 60 + eM;
            if (endMin < startMin) return current >= startMin || current <= endMin;
            else return current >= startMin && current <= endMin;
        };

        // --- COMPONENTES UI ---
        const GlobalModal = ({ modal, close }) => {
            if (!modal.isOpen) return null;
            return (
                <div className="modal-overlay" onClick={modal.type === 'alert' ? close : undefined}>
                    <div className="modal-box" onClick={e => e.stopPropagation()}>
                        {modal.type === 'loading' ? (
                            <div className="py-4">
                                <div className="loader border-blue-500 border-b-transparent mb-4 mx-auto" style={{borderColor: modal.color || '#3b82f6', borderBottomColor: 'transparent'}}></div>
                                <h3 className="text-lg font-bold text-gray-800">{modal.title}</h3>
                            </div>
                        ) : (
                            <>
                                <div className={`text-5xl mb-4 ${modal.type === 'error' ? 'text-red-500' : modal.type === 'success' ? 'text-green-500' : 'text-blue-500'}`}>
                                    {modal.icon ? <i className={modal.icon}></i> : 
                                     modal.type === 'error' ? <i className="fa-regular fa-circle-xmark"></i> :
                                     modal.type === 'success' ? <i className="fa-regular fa-circle-check"></i> :
                                     <i className="fa-solid fa-circle-info"></i>}
                                </div>
                                <h3 className="text-xl font-bold text-gray-800 mb-2">{modal.title}</h3>
                                <p className="text-gray-500 text-sm mb-6 px-2">{modal.message}</p>
                                <div className="flex gap-3">
                                    {modal.type === 'confirm' && (
                                        <button onClick={close} className="flex-1 py-3 border border-gray-200 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition">Cancelar</button>
                                    )}
                                    <button 
                                        onClick={() => { if(modal.onConfirm) modal.onConfirm(); close(); }} 
                                        className={`flex-1 py-3 rounded-xl text-white font-bold shadow-lg transform active:scale-95 transition ${modal.type === 'error' ? 'bg-red-500' : 'bg-blue-600'}`}
                                        style={modal.confirmStyle}
                                    >
                                        {modal.confirmText || 'OK'}
                                    </button>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const Toast = ({ msg }) => {
            if (!msg) return null;
            return (
                <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-900/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl z-[10000] flex items-center gap-3 animate-float">
                    <i className="fa-solid fa-circle-check text-green-400"></i>
                    <span className="font-medium text-sm">{msg}</span>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [view, setView] = useState("menu");
            const [activeOrder, setActiveOrder] = useState(null); 
            const [cart, setCart] = useState(() => { try { return JSON.parse(localStorage.getItem('fritzza_cart')) || []; } catch(e) { return []; } });
            const [modal, setModal] = useState({ isOpen: false, type: 'alert' });
            const [toast, setToast] = useState(null);
            
            const [products, setProducts] = useState([]);
            const [categories, setCategories] = useState([]);
            const [neighborhoods, setNeighborhoods] = useState([]);
            const [settings, setSettings] = useState({ 
                appName: "Fritzza", themeColor: "#dc2626", openTime: "18:00", closeTime: "23:00",
                cardStyle: "grid", borderRadius: "rounded-2xl" 
            });
            const [loading, setLoading] = useState(true);

            // Helpers de Modal
            const showAlert = (title, message, type='alert', icon=null) => setModal({ isOpen: true, type, title, message, icon });
            const showConfirm = (title, message, onConfirm) => setModal({ isOpen: true, type: 'confirm', title, message, onConfirm });
            const showLoading = (title='Carregando...') => setModal({ isOpen: true, type: 'loading', title, color: settings.themeColor });
            const closeModal = () => setModal({ ...modal, isOpen: false });
            const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

            useEffect(() => { localStorage.setItem('fritzza_cart', JSON.stringify(cart)); }, [cart]);

            useEffect(() => {
                const init = async () => {
                    if (!auth.currentUser) await auth.signInAnonymously();
                    const root = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
                    
                    root.collection('config').doc('main').onSnapshot(d => { if (d.exists) { setSettings(prev => ({...prev, ...d.data()})); if(d.data().bgColor) document.body.style.backgroundColor = d.data().bgColor; } });
                    root.collection('categories').orderBy('order').onSnapshot(s => setCategories(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    root.collection('products').onSnapshot(s => setProducts(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    root.collection('neighborhoods').onSnapshot(s => setNeighborhoods(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    
                    const savedOrderId = localStorage.getItem('fritzza_last_order');
                    if (savedOrderId) {
                        const savedOrderDate = localStorage.getItem('fritzza_last_order_date');
                        const isRecent = savedOrderDate && (new Date() - new Date(savedOrderDate)) < 86400000;
                        if(isRecent) setActiveOrder(savedOrderId);
                    }
                    setLoading(false);
                };
                init();
            }, []);

            const addToCart = (p, e) => {
                // AnimaÃ§Ã£o da imagem voando (SÃ³ funciona se o card tiver imagem)
                if(e) {
                    const card = e.currentTarget.closest('.product-card');
                    const img = card ? card.querySelector('img') : null;
                    if(img) {
                        const clone = img.cloneNode(true);
                        const rect = img.getBoundingClientRect();
                        clone.style.cssText = `position:fixed; left:${rect.left}px; top:${rect.top}px; width:${rect.width}px; height:${rect.height}px; z-index:9999; border-radius:50%; pointer-events:none; transition: all 0.6s cubic-bezier(0.2, 1, 0.3, 1);`;
                        clone.className = 'flying-img';
                        document.body.appendChild(clone);
                        const cartBtn = document.getElementById('cart-fab-btn');
                        if(cartBtn) {
                            const dest = cartBtn.getBoundingClientRect();
                            setTimeout(() => {
                                clone.style.left = (dest.left + dest.width/2 - 20) + 'px';
                                clone.style.top = (dest.top + dest.height/2 - 20) + 'px';
                                clone.style.width = '40px'; clone.style.height = '40px'; clone.style.opacity = '0';
                            }, 10);
                        }
                        setTimeout(() => clone.remove(), 600);
                    }
                }
                setCart(prev => {
                    const exists = prev.find(i => i.id === p.id);
                    if (exists) return prev.map(i => i.id === p.id ? { ...i, quantity: i.quantity + 1 } : i);
                    return [...prev, { ...p, quantity: 1 }];
                });
                showToast(`+1 ${p.name} adicionado!`);
            };

            const handleOrderCreated = (orderId) => {
                setActiveOrder(orderId);
                localStorage.setItem('fritzza_last_order', orderId);
                localStorage.setItem('fritzza_last_order_date', new Date().toISOString());
                setCart([]);
                setView("status");
            };

            const themeStyle = { backgroundColor: settings.themeColor || '#dc2626' };
            const textThemeStyle = { color: settings.themeColor || '#dc2626' };
            const borderStyle = settings.borderRadius || 'rounded-2xl'; // rounded-2xl, rounded-lg, rounded-none

            if (loading) return <div className="h-screen flex flex-col items-center justify-center text-gray-400 bg-gray-50"><div className="loader border-gray-400 border-b-transparent mb-4"></div><p>Carregando...</p></div>;

            return (
                <div className="min-h-screen pb-24 relative overflow-hidden">
                    <GlobalModal modal={modal} close={closeModal} />
                    <Toast msg={toast} />

                    {/* Header */}
                    {view !== 'status' && (
                        <header className="sticky top-0 z-40 transition-all duration-300">
                            <div className={`relative overflow-hidden pt-4 pb-12 px-4 shadow-lg ${settings.borderRadius === 'rounded-none' ? '' : 'rounded-b-[2rem]'}`} style={themeStyle}>
                                {settings.bannerUrl ? (
                                    <div className="absolute inset-0 z-0"><img src={settings.bannerUrl} className="w-full h-full object-cover opacity-30" /></div>
                                ) : (
                                    <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/food.png')]"></div>
                                )}
                                <div className="relative z-10 flex justify-between items-center">
                                    <div className="flex items-center gap-3 text-white">
                                        {settings.logoStyle !== 'none' && (
                                            <div className={`w-12 h-12 bg-white/20 backdrop-blur flex items-center justify-center border-2 border-white/30 shadow-inner ${settings.logoStyle==='circle'?'rounded-full':'rounded-lg'}`}>
                                                {settings.logoUrl ? <img src={settings.logoUrl} className={`w-full h-full object-cover ${settings.logoStyle==='circle'?'rounded-full':'rounded-lg'}`} /> : <span className="font-chewy text-2xl">{settings.appName?.[0]}</span>}
                                            </div>
                                        )}
                                        <div>
                                            <h1 className="font-chewy text-2xl leading-none">{settings.appName}</h1>
                                            <p className="text-white/80 text-xs font-medium tracking-wide">{settings.appSubtitle}</p>
                                        </div>
                                    </div>
                                    {activeOrder && (
                                        <button onClick={()=>setView("status")} className="bg-white/20 backdrop-blur text-white px-3 py-1.5 rounded-full text-xs font-bold border border-white/30 animate-pulse">
                                            <i className="fa-solid fa-motorcycle mr-1"></i> Acompanhar
                                        </button>
                                    )}
                                </div>
                            </div>
                        </header>
                    )}

                    <main className={`container mx-auto max-w-lg ${view === 'menu' ? '-mt-8' : ''} relative z-20 px-4`}>
                        {view === "menu" && <MenuView products={products} categories={categories} addToCart={addToCart} settings={settings} theme={themeStyle} border={borderStyle} />}
                        {view === "checkout" && <CheckoutView cart={cart} setCart={setCart} settings={settings} neighborhoods={neighborhoods} onBack={()=>setView("menu")} onCreated={handleOrderCreated} showAlert={showAlert} showConfirm={showConfirm} showLoading={showLoading} closeModal={closeModal} theme={themeStyle} border={borderStyle} />}
                        {view === "status" && <OrderStatusView orderId={activeOrder} onBack={()=>setView("menu")} theme={themeStyle} border={borderStyle} />}
                    </main>

                    {view === "menu" && cart.length > 0 && (
                        <div className="fixed bottom-6 left-0 right-0 px-4 z-50 flex justify-center">
                            <button id="cart-fab-btn" onClick={()=>setView("checkout")} className={`w-full max-w-lg p-4 shadow-2xl flex items-center justify-between transform transition hover:scale-[1.02] active:scale-95 text-white ${borderStyle}`} style={{backgroundColor: settings.cartColor || '#16a34a'}}>
                                <div className="flex items-center gap-3">
                                    <div className="bg-white text-gray-900 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">{cart.reduce((a,b)=>a+b.quantity,0)}</div>
                                    <div className="text-left"><div className="text-xs opacity-80">Total</div><div className="font-bold text-lg leading-none">{formatMoney(cart.reduce((a,b)=>a+(b.price*b.quantity),0))}</div></div>
                                </div>
                                <div className="flex items-center gap-2 font-bold text-sm bg-black/20 px-4 py-2 rounded-xl">Ver Sacola <i className="fa-solid fa-arrow-right"></i></div>
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const MenuView = ({ products, categories, addToCart, settings, theme, border }) => {
            const [search, setSearch] = useState("");
            const [catSel, setCatSel] = useState("Todas");
            const isOpen = isStoreOpen(settings.openTime, settings.closeTime);
            
            const filteredProducts = useMemo(() => {
                let list = products;
                if (search) list = list.filter(p => p.name.toLowerCase().includes(search.toLowerCase()) || p.description?.toLowerCase().includes(search.toLowerCase()));
                if (catSel !== "Todas") list = list.filter(p => p.category === catSel);
                return list;
            }, [products, search, catSel]);

            return (
                <div className="pb-10">
                    <div className={`bg-white shadow-lg p-4 mb-6 glass-panel ${border}`}>
                        <div className={`flex items-center justify-center gap-2 text-sm font-bold mb-4 ${isOpen ? 'text-green-600' : 'text-red-500'}`}>
                            <div className={`w-2 h-2 rounded-full ${isOpen ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                            {isOpen ? "Aberto agora" : `Fechado â€¢ Abre Ã s ${settings.openTime}`}
                        </div>
                        <div className="relative">
                            <i className="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" placeholder="Buscar..." className={`w-full bg-gray-100 border-none py-3 pl-10 pr-4 text-gray-700 focus:ring-2 focus:ring-opacity-50 outline-none transition ${border}`} style={{'--tw-ring-color': settings.themeColor}} value={search} onChange={e=>setSearch(e.target.value)} />
                        </div>
                    </div>

                    <div className="flex gap-2 overflow-x-auto pb-4 hide-scrollbar mb-2 sticky top-20 z-30 py-2 -mx-4 px-4 bg-gradient-to-b from-[#f8fafc] to-transparent">
                        <button onClick={()=>setCatSel("Todas")} className={`px-4 py-2 text-sm font-bold whitespace-nowrap transition shadow-sm ${catSel==="Todas" ? 'text-white shadow-md transform scale-105' : 'bg-white text-gray-500 border border-gray-100'} ${border}`} style={catSel==="Todas"?theme:{}}>Todas</button>
                        {categories.map(c => (<button key={c.id} onClick={()=>setCatSel(c.name)} className={`px-4 py-2 text-sm font-bold whitespace-nowrap transition shadow-sm ${catSel===c.name ? 'text-white shadow-md transform scale-105' : 'bg-white text-gray-500 border border-gray-100'} ${border}`} style={catSel===c.name?theme:{}}>{c.name}</button>))}
                    </div>

                    <div className={`space-y-6 ${settings.cardStyle === 'grid' ? '' : 'max-w-md mx-auto'}`}>
                        {filteredProducts.length === 0 ? <div className="text-center py-10 opacity-50"><p>Nenhum produto encontrado.</p></div> : 
                        catSel === "Todas" && !search ? categories.map(cat => {
                            const prods = filteredProducts.filter(p => p.category === cat.name);
                            if(prods.length === 0) return null;
                            return <div key={cat.id}><h2 className="font-bold text-lg text-gray-800 mb-3 flex items-center gap-2"><span className="w-1 h-6 rounded-full" style={theme}></span> {cat.name}</h2><div className={`grid gap-4 ${settings.cardStyle === 'grid' ? 'grid-cols-1' : 'grid-cols-1'}`}>{prods.map(p => <ProductCard key={p.id} p={p} addToCart={addToCart} theme={theme} border={border} styleType={settings.cardStyle} />)}</div></div>;
                        }) : <div className={`grid gap-4 ${settings.cardStyle === 'grid' ? 'grid-cols-1' : 'grid-cols-1'}`}>{filteredProducts.map(p => <ProductCard key={p.id} p={p} addToCart={addToCart} theme={theme} border={border} styleType={settings.cardStyle} />)}</div>}
                    </div>
                </div>
            );
        };

        const ProductCard = ({ p, addToCart, theme, border, styleType }) => {
            if (styleType === 'minimal') {
                return (
                    <div className={`bg-white p-4 shadow-sm border border-gray-100 flex justify-between items-center group hover:shadow-md transition ${border}`}>
                        <div className="flex-1 pr-4">
                            <h3 className="font-bold text-gray-800 leading-tight mb-1">{p.name}</h3>
                            <p className="text-xs text-gray-500 line-clamp-1">{p.description}</p>
                            <span className="font-bold text-sm text-gray-800 mt-1 block">{formatMoney(p.price)}</span>
                        </div>
                        <button onClick={(e) => addToCart(p, e)} className="w-8 h-8 rounded-full text-white shadow flex items-center justify-center active:scale-90 transition" style={theme}><i className="fa-solid fa-plus text-xs"></i></button>
                    </div>
                );
            }
            if (styleType === 'list') {
                return (
                    <div className={`bg-white p-3 shadow-sm border border-gray-100 flex gap-3 relative group hover:shadow-md transition ${border}`}>
                        {p.imageUrl && <div className={`w-20 h-20 bg-gray-100 flex-shrink-0 relative overflow-hidden ${border}`}><img src={p.imageUrl} className="w-full h-full object-cover" /></div>}
                        <div className="flex-1 flex flex-col justify-between py-1">
                            <div><h3 className="font-bold text-gray-800 leading-tight mb-1">{p.name}</h3><p className="text-xs text-gray-500 line-clamp-2">{p.description}</p></div>
                            <div className="flex justify-between items-end mt-2"><span className="font-bold text-gray-800">{formatMoney(p.price)}</span><button onClick={(e) => addToCart(p, e)} className="w-7 h-7 rounded-full text-white shadow flex items-center justify-center active:scale-90 transition" style={theme}><i className="fa-solid fa-plus text-xs"></i></button></div>
                        </div>
                    </div>
                );
            }
            // Grid / Default
            return (
                <div className={`bg-white p-3 shadow-sm border border-gray-100 flex gap-4 overflow-hidden relative group hover:shadow-md transition ${border}`}>
                    <div className={`w-28 h-28 bg-gray-100 flex-shrink-0 relative overflow-hidden ${border}`}>
                        {p.imageUrl ? <img src={p.imageUrl} className="w-full h-full object-cover transition duration-500 group-hover:scale-110" /> : <div className="w-full h-full flex items-center justify-center text-gray-300"><i className="fa-solid fa-utensils text-2xl"></i></div>}
                    </div>
                    <div className="flex-1 flex flex-col justify-between py-1">
                        <div><h3 className="font-bold text-gray-800 leading-tight mb-1 line-clamp-2">{p.name}</h3><p className="text-xs text-gray-500 line-clamp-2 leading-relaxed">{p.description}</p></div>
                        <div className="flex justify-between items-end mt-2"><span className="font-bold text-lg text-gray-800">{formatMoney(p.price)}</span><button onClick={(e) => addToCart(p, e)} className="w-8 h-8 rounded-full text-white shadow-lg flex items-center justify-center active:scale-90 transition" style={theme}><i className="fa-solid fa-plus text-xs"></i></button></div>
                    </div>
                </div>
            );
        };

        const CheckoutView = ({ cart, setCart, settings, neighborhoods, onBack, onCreated, showAlert, showConfirm, showLoading, closeModal, theme, border }) => {
            const [step, setStep] = useState(1);
            const [form, setForm] = useState({ name: "", phone: "", cep: "", address: "", number: "", bairro: "", complement: "" });
            const [del, setDel] = useState({ fee: 0, method: 'pendente' });
            const [payMethod, setPayMethod] = useState("");
            const [change, setChange] = useState("");
            const [pixData, setPixData] = useState(null);
            
            const totalItems = cart.reduce((a,b)=>a+(b.price*b.quantity),0);
            const total = totalItems + del.fee;

            const handleCep = async (cep) => {
                const c = cep.replace(/\D/g, ''); setForm(p=>({...p, cep:c}));
                if(c.length === 8) {
                    try { const res = await fetch(`https://viacep.com.br/ws/${c}/json/`); const data = await res.json(); if(!data.erro) { setForm(p=>({...p, address: data.logradouro, bairro: data.bairro})); } } catch(e){}
                }
            };
            useEffect(() => {
                if(form.bairro && neighborhoods.length > 0) {
                    const bMatch = neighborhoods.find(n => n.name.toLowerCase() === form.bairro.toLowerCase());
                    if(bMatch) setDel({ fee: bMatch.price, method: 'bairro_fixo' }); else if(del.method === 'pendente') setDel({ fee: 5.00, method: 'fixo_padrao' });
                }
            }, [form.bairro, neighborhoods]);

            const handlePix = async () => {
                if(!form.name) return;
                showLoading("Gerando Pix...");
                try {
                    const mpUrl = "https://api.mercadopago.com/v1/payments"; const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(mpUrl);
                    const res = await fetch(proxyUrl, { method: "POST", headers: { "Authorization": `Bearer ${settings.mercadoPagoToken}`, "Content-Type": "application/json", "X-Idempotency-Key": Date.now().toString() }, body: JSON.stringify({ transaction_amount: Number(total.toFixed(2)), description: `Pedido ${settings.appName}`, payment_method_id: "pix", payer: { email: "cliente@email.com", first_name: form.name } }) });
                    const data = await res.json();
                    if(data.point_of_interaction) { setPixData(data); setPayMethod('Pix'); closeModal(); } else { throw new Error(); }
                } catch(e) { closeModal(); showAlert("Erro", "Erro Pix"); }
            };

            const finishOrder = async () => {
                if(!form.name || !form.phone || !form.address) return showAlert("Ops", "Preencha tudo.");
                showLoading("Enviando...");
                try {
                    const ref = await getCol('orders').add({ customer: form, items: cart, totals: { sub: totalItems, del: del.fee, total: total }, payment: { method: payMethod, change: change }, createdAt: new Date().toISOString(), status: 'pendente' });
                    // Clean phone and save user logic...
                    let msg = `*NOVO PEDIDO DE ${form.name.toUpperCase()}*\nðŸ“ ${form.address}, ${form.number} - ${form.bairro}\n\n`; cart.forEach(i => msg += `${i.quantity}x ${i.name}\n`); msg += `\nðŸ’° Total: ${formatMoney(total)}\nðŸ’³ Pag: ${payMethod}`;
                    closeModal(); onCreated(ref.id); window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
                } catch(e) { closeModal(); showAlert("Erro", "Erro ao enviar."); }
            };

            return (
                <div className="pt-8">
                    <button onClick={onBack} className="mb-4 text-gray-500 font-bold flex items-center gap-2 text-sm"><i className="fa-solid fa-arrow-left"></i> Voltar</button>
                    <div className={`bg-white shadow-xl overflow-hidden ${border}`}>
                        <div className="bg-gray-50 p-6 border-b">
                            <h2 className="text-2xl font-bold text-gray-800">Seu Pedido</h2>
                            <div className="mt-4 space-y-3">{cart.map(i => (<div key={i.id} className="flex justify-between items-center text-sm"><div className="flex items-center gap-3"><span className="bg-gray-200 text-gray-700 w-6 h-6 rounded flex items-center justify-center font-bold text-xs">{i.quantity}</span><span className="text-gray-600">{i.name}</span></div><div className="flex items-center gap-3"><span className="font-medium">{formatMoney(i.price * i.quantity)}</span><button onClick={()=>setCart(p=>p.filter(x=>x.id!==i.id))} className="text-red-400 text-xs"><i className="fa-solid fa-trash"></i></button></div></div>))}</div>
                        </div>
                        <div className="p-6">
                            {step === 1 ? (
                                <div className="space-y-4 animate-fade-in">
                                    <h3 className="font-bold text-gray-800 border-l-4 pl-3" style={{borderColor: settings.themeColor}}>Entrega</h3>
                                    <input placeholder="Nome" className={`border p-3 bg-gray-50 w-full ${border}`} value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                                    <input type="tel" placeholder="WhatsApp" className={`border p-3 bg-gray-50 w-full ${border}`} value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} />
                                    <div className="flex gap-2"><input placeholder="CEP" className={`border p-3 bg-gray-50 w-1/3 ${border}`} value={form.cep} onChange={e=>handleCep(e.target.value)} /><input placeholder="EndereÃ§o" className={`border p-3 bg-gray-100 flex-1 ${border}`} value={form.address} readOnly /></div>
                                    <div className="flex gap-2"><input placeholder="NÂº" className={`border p-3 bg-gray-50 w-1/4 ${border}`} value={form.number} onChange={e=>setForm({...form, number:e.target.value})} /><input placeholder="Bairro" className={`border p-3 bg-gray-100 flex-1 ${border}`} value={form.bairro} readOnly /></div>
                                    <div className="flex justify-between items-center p-3 bg-blue-50 text-blue-800 text-sm rounded-lg"><span>Taxa Entrega</span><span className="font-bold">{del.fee > 0 ? formatMoney(del.fee) : '...'}</span></div>
                                    <button onClick={()=>{ if(form.address) setStep(2); else showAlert("Ops", "EndereÃ§o incompleto"); }} className={`w-full py-4 text-white font-bold mt-4 shadow-lg ${border}`} style={theme}>Pagamento</button>
                                </div>
                            ) : (
                                <div className="space-y-4 animate-fade-in">
                                    <h3 className="font-bold text-gray-800 border-l-4 pl-3" style={{borderColor: settings.themeColor}}>Pagamento</h3>
                                    <div className="grid grid-cols-2 gap-3">{['Dinheiro', 'CartÃ£o', 'Pix'].map(m => (<button key={m} onClick={() => { setPayMethod(m); if(m==='Pix' && settings.mercadoPagoToken) handlePix(); else setPixData(null); }} className={`p-4 border text-sm font-bold transition ${border} ${payMethod === m ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200'}`}>{m}</button>))}</div>
                                    {payMethod === 'Dinheiro' && <input type="number" placeholder="Troco para?" className={`w-full p-3 border bg-yellow-50 ${border}`} value={change} onChange={e=>setChange(e.target.value)} />}
                                    {pixData && (<div className={`bg-teal-50 p-4 border border-teal-200 text-center ${border}`}><img src={`data:image/png;base64,${pixData.point_of_interaction.transaction_data.qr_code_base64}`} className="w-40 h-40 mx-auto mix-blend-multiply" /><p className="text-xs text-teal-700 mt-2">Copie e cole no banco</p></div>)}
                                    <div className="border-t pt-4 mt-4"><div className="flex justify-between text-xl font-bold text-gray-800 mb-6"><span>Total Final</span><span>{formatMoney(total)}</span></div><button onClick={finishOrder} className={`w-full py-4 bg-green-500 hover:bg-green-600 text-white font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2 ${border}`}><span>Confirmar Pedido</span><i className="fa-brands fa-whatsapp"></i></button><button onClick={()=>setStep(1)} className="w-full py-3 text-gray-400 text-sm font-bold mt-2">Voltar</button></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const OrderStatusView = ({ orderId, onBack, theme, border }) => {
            const [order, setOrder] = useState(null);
            useEffect(() => { const unsub = getCol('orders').doc(orderId).onSnapshot(d => { if(d.exists) setOrder({ id: d.id, ...d.data() }); }); return () => unsub(); }, [orderId]);
            if(!order) return <div className="text-center py-10"><div className="loader border-gray-400"></div></div>;
            const steps = [{ s: 'pendente', label: 'Recebido' }, { s: 'confirmado', label: 'Confirmado' }, { s: 'preparando', label: 'Preparando' }, { s: 'enviado', label: 'Saiu p/ Entrega' }, { s: 'entregue', label: 'Entregue' }];
            const currentIdx = steps.findIndex(st => st.s === order.status) || 0;
            const progress = (currentIdx / (steps.length - 1)) * 100;

            return (
                <div className="pt-8 min-h-screen">
                    <div className={`bg-white shadow-xl overflow-hidden mb-6 relative ${border}`}>
                        <div className="p-8 text-center text-white relative overflow-hidden" style={theme}><div className="absolute inset-0 bg-black/10"></div><div className="relative z-10"><div className="text-sm opacity-80 mb-2">PEDIDO #{order.id.slice(-4)}</div><h2 className="text-3xl font-chewy mb-2 animate-pulse">{steps[currentIdx].label}</h2></div></div>
                        <div className="p-8 bg-gray-50"><div className="relative pl-8 space-y-8"><div className="step-line absolute left-[15px] top-2 bottom-2 w-1 bg-gray-200"></div><div className="step-line absolute left-[15px] top-2 w-1 transition-all duration-1000" style={{height: `${progress}%`, ...theme}}></div>{steps.map((st, i) => { const active = i <= currentIdx; return (<div key={st.s} className={`step-item flex items-center gap-4 ${active ? 'opacity-100' : 'opacity-40 grayscale'}`}><div className={`w-8 h-8 rounded-full flex items-center justify-center text-white z-10 shadow-md transition-all duration-500 ${active ? 'scale-110' : 'scale-100 bg-gray-300'}`} style={active ? theme : {}}><i className="fa-solid fa-check text-xs"></i></div><div className="font-bold text-gray-800">{st.label}</div></div>); })}</div></div>
                    </div>
                    <button onClick={() => { localStorage.removeItem('fritzza_last_order'); onBack(); }} className={`w-full py-4 bg-white border-2 text-gray-500 font-bold hover:bg-gray-50 ${border}`}>Novo Pedido</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

