<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fritzza - Delivery</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .loader { border-top-color: currentColor; -webkit-animation: spinner 1s linear infinite; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body>
    
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div class="loader" style="width: 50px; height: 50px; border-radius: 50%; border: 4px solid #ddd; color: #ef4444;"></div>
            <p style="margin-top: 20px; color: #666;">Carregando...</p>
        </div>
    </div>

    <script type="text/babel">
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAg2kfoWsvWWyEXQGe8v6jZZqKepgButUk",
            authDomain: "ajuda-2217b.firebaseapp.com",
            projectId: "ajuda-2217b",
            storageBucket: "ajuda-2217b.firebasestorage.app",
            messagingSenderId: "421083897636",
            appId: "1:421083897636:web:18bd6097b5c0169427ddb1"
        };

        if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) {} }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = "ajuda-2217b"; 
        const getCol = (n) => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(n);

        const { useState, useEffect, useRef, useMemo } = React;
        const formatMoney = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        // --- COORDENADAS ATUALIZADAS (Fritzza) ---
        const RESTAURANT_COORDS = { lat: -24.9157467, lng: -53.4264409 };
        const WHATSAPP_NUMBER = "5545988166885";
        const PIX_KEY = "63.149.169/0001-28";

        // --- APP ---
        const App = () => {
            const [view, setView] = useState("menu");
            
            // CARRINHO PERSISTENTE
            const [cart, setCart] = useState(() => {
                try {
                    const saved = localStorage.getItem('fritzza_cart');
                    return saved ? JSON.parse(saved) : [];
                } catch(e) { return []; }
            });

            useEffect(() => {
                localStorage.setItem('fritzza_cart', JSON.stringify(cart));
            }, [cart]);

            const [products, setProducts] = useState([]);
            const [categories, setCategories] = useState([]);
            const [settings, setSettings] = useState({ pricePerKm: 2.00, themeColor: "#dc2626", logoUrl: "" });
            const [catSel, setCatSel] = useState("Todas");
            const [loginOpen, setLoginOpen] = useState(false);
            const [loading, setLoading] = useState(true);
            const [neighborhoods, setNeighborhoods] = useState([]);

            const themeStyle = { backgroundColor: settings.themeColor || '#dc2626' };
            const textThemeStyle = { color: settings.themeColor || '#dc2626' };
            const borderThemeStyle = { borderColor: settings.themeColor || '#dc2626' };

            useEffect(() => {
                const init = async () => {
                    if (!auth.currentUser) await auth.signInAnonymously();
                    const root = db.collection('artifacts').doc(APP_ID).collection('public').doc('data');
                    
                    root.collection('products').onSnapshot(s => setProducts(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    root.collection('categories').orderBy('order').onSnapshot(s => {
                        const c = s.docs.map(d => ({ id: d.id, ...d.data() }));
                        if(c.length===0 && !loading) seedCategories(); else setCategories(c);
                    });
                    root.collection('config').doc('main').onSnapshot(d => {
                        if (d.exists) setSettings(d.data());
                        else root.collection('config').doc('main').set({ pricePerKm: 2.00, themeColor: "#dc2626" });
                    });
                    root.collection('neighborhoods').onSnapshot(s => setNeighborhoods(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                    setLoading(false);
                };
                init();
            }, []);

            const seedCategories = () => {
                const batch = db.batch();
                ["Pizzas", "Bebidas", "Combos"].forEach((n, i) => batch.set(getCol('categories').doc(), { name: n, order: i }));
                batch.commit();
            };

            const addToCart = (p) => setCart(prev => {
                const ex = prev.find(i => i.id === p.id);
                return ex ? prev.map(i => i.id === p.id ? { ...i, quantity: i.quantity + 1 } : i) : [...prev, { ...p, quantity: 1 }];
            });

            const total = cart.reduce((a,b)=>a+(b.price*b.quantity),0);

            if (loading) return null;

            return (
                <div className="min-h-screen pb-24 bg-gray-50 font-sans">
                    <header style={themeStyle} className="text-white p-4 sticky top-0 z-40 shadow-md flex justify-between items-center transition-colors duration-300">
                        <div className="flex items-center gap-3">
                            {settings.logoUrl ? (
                                <img src={settings.logoUrl} alt="Logo" className="w-12 h-12 rounded-full object-cover bg-white border-2 border-white" />
                            ) : (
                                <div className="bg-white text-current w-10 h-10 rounded-full flex items-center justify-center font-bold text-xl" style={textThemeStyle}>F</div>
                            )}
                            <div><h1 className="font-bold text-lg leading-tight">Fritzza</h1><p className="text-xs opacity-90">Delivery</p></div>
                        </div>
                        {view === "admin" ? 
                            <button onClick={()=>setView("menu")} className="text-xs bg-white text-gray-800 px-3 py-1 rounded-full font-bold">Sair Admin</button> :
                            <button onClick={()=>setLoginOpen(true)}><i className="fa-solid fa-lock text-xl opacity-80 hover:opacity-100"></i></button>
                        }
                    </header>

                    {loginOpen && <AdminLogin theme={themeStyle} onLogin={()=>{setLoginOpen(false);setView("admin")}} onCancel={()=>setLoginOpen(false)} />}

                    <main className="container mx-auto p-4 max-w-4xl">
                        {view === "menu" && <MenuView products={products} categories={categories} catSel={catSel} setCatSel={setCatSel} addToCart={addToCart} theme={themeStyle} border={borderThemeStyle} text={textThemeStyle} />}
                        {view === "checkout" && <CheckoutView cart={cart} setCart={setCart} total={total} settings={settings} neighborhoods={neighborhoods} products={products} onBack={()=>setView("menu")} onClear={()=>setCart([])} theme={themeStyle} text={textThemeStyle} />}
                        {view === "admin" && <AdminPanel products={products} categories={categories} settings={settings} neighborhoods={neighborhoods} theme={themeStyle} />}
                    </main>

                    {view === "menu" && cart.length > 0 && (
                        <div className="fixed bottom-4 left-0 right-0 px-4 flex justify-center z-50 animate-fade-in">
                            <button onClick={()=>setView("checkout")} className="bg-green-600 text-white w-full max-w-md p-4 rounded-xl shadow-xl flex justify-between items-center hover:bg-green-700 transition transform hover:scale-105">
                                <div className="flex items-center gap-2">
                                    <span className="bg-green-800 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">{cart.reduce((a,b)=>a+b.quantity,0)}</span>
                                    <span>Ver Carrinho</span>
                                </div>
                                <span className="font-bold text-lg">{formatMoney(total)}</span>
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // --- VIEWS ---
        const MenuView = ({ products, categories, catSel, setCatSel, addToCart, theme, border, text }) => {
            const handleCat = (n) => { setCatSel(n); if(n==="Todas") window.scrollTo(0,0); };
            const ProductCard = ({ p }) => (
                <div className="bg-white p-3 rounded-xl shadow-sm border flex gap-3 hover:shadow-md transition">
                    <div className="w-24 h-24 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0 relative">
                        {p.imageUrl ? <img src={p.imageUrl} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-300"><i className="fa-solid fa-utensils"></i></div>}
                    </div>
                    <div className="flex-1 flex flex-col justify-between">
                        <div><h3 className="font-bold text-gray-800 leading-tight">{p.name}</h3><p className="text-xs text-gray-500 line-clamp-2 mt-1">{p.description}</p></div>
                        <div className="flex justify-between items-end mt-2">
                            <span className="font-bold text-lg" style={{color: 'green'}}>{formatMoney(p.price)}</span>
                            <button onClick={()=>addToCart(p)} style={{...theme, color: 'white'}} className="w-8 h-8 rounded-full flex items-center justify-center hover:opacity-90"><i className="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div>
                    <div className="flex overflow-x-auto gap-2 pb-4 mb-4 hide-scrollbar sticky top-20 z-30 bg-gray-50 py-2">
                        <button onClick={()=>handleCat("Todas")} style={catSel==="Todas" ? theme : {}} className={`px-5 py-2 rounded-full whitespace-nowrap text-sm font-bold transition shadow-sm ${catSel==="Todas"?"text-white shadow-md":"bg-white text-gray-600 border"}`}>Todas</button>
                        {categories.map(c => <button key={c.id} onClick={()=>handleCat(c.name)} style={catSel===c.name ? theme : {}} className={`px-5 py-2 rounded-full whitespace-nowrap text-sm font-bold transition shadow-sm ${catSel===c.name?"text-white shadow-md":"bg-white text-gray-600 border"}`}>{c.name}</button>)}
                    </div>
                    <div className="space-y-8">
                        {catSel === "Todas" ? categories.map(cat => {
                            const cp = products.filter(p => p.category === cat.name);
                            if (cp.length === 0) return null;
                            return <div key={cat.id}><h3 className="font-bold text-xl text-gray-800 mb-3 pl-1 border-l-4" style={border}>{cat.name}</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{cp.map(p=><ProductCard key={p.id} p={p}/>)}</div></div>
                        }) : <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{products.filter(p=>p.category===catSel).length===0?<div className="col-span-full text-center text-gray-400 py-10">Nada aqui.</div>:products.filter(p=>p.category===catSel).map(p=><ProductCard key={p.id} p={p}/>)}</div>}
                    </div>
                </div>
            );
        };

        const CheckoutView = ({ cart, setCart, total, settings, neighborhoods, products, onBack, onClear, theme, text }) => {
            const [form, setForm] = useState({ name: "", phone: "", address: "", bairro: "", complement: "" });
            const [del, setDel] = useState({ fee: 0, km: 0, loading: false, lat: null, lon: null, method: 'pendente' });
            const [payMethod, setPayMethod] = useState("");
            const [change, setChange] = useState("");
            
            const [couponCode, setCouponCode] = useState("");
            const [appliedCoupon, setAppliedCoupon] = useState(null);
            const [typingTimer, setTypingTimer] = useState(null);

            // Autopreenchimento
            useEffect(() => {
                if (form.address && form.address.length > 3 && form.bairro && form.bairro.length > 2) {
                    setDel(p => ({ ...p, loading: true }));
                    if (typingTimer) clearTimeout(typingTimer);
                    const timer = setTimeout(() => calcAddress(form.address, form.bairro), 1500);
                    setTypingTimer(timer);
                }
            }, [form.address, form.bairro]);

            const check = async () => {
                const clean = form.phone.replace(/\D/g, '');
                if(clean.length<8) return;
                const snap = await getCol('customers').where('phoneRaw','==',clean).limit(1).get();
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    setForm(p => ({...p, name:d.name, address:d.address, bairro:d.bairro||"", complement:d.complement||""}));
                }
            };

            // --- FUN√á√ÉO DE ERRO CR√çTICO E LIMPEZA ---
            const handleAddressError = () => {
                setDel({ fee: 0, km: 0, loading: false, lat: null, lon: null, method: 'pendente' });
                setForm(prev => ({ ...prev, address: "", bairro: "" })); // Limpa campos
                alert("‚ö†Ô∏è Endere√ßo n√£o localizado ou fora de Cascavel.\n\nPor favor, verifique o nome da rua e do bairro.\nO sistema aceita apenas entregas em Cascavel - PR.");
            };

            const calcAddress = async (addr, bairroInput) => {
                // 1. Verifica Taxa Fixa por Bairro (Prioridade)
                const bairroMatch = neighborhoods.find(n => n.name.toLowerCase().trim() === bairroInput.toLowerCase().trim());
                if (bairroMatch) {
                    setDel({ fee: parseFloat(bairroMatch.price), km: 0, loading: false, method: 'bairro_fixo', lat: null, lon: null });
                    return;
                }

                try {
                    // 2. Busca Estruturada
                    const query = `${addr}, ${bairroInput}, Cascavel, PR, Brazil`;
                    let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&addressdetails=1`);
                    let data = await res.json();

                    // Fallback: Tenta busca sem bairro se falhar
                    if (data.length === 0) {
                        const queryFallback = `${addr}, Cascavel, PR, Brazil`;
                        res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(queryFallback)}&limit=1&addressdetails=1`);
                        data = await res.json();
                    }

                    if(data.length > 0) {
                        const item = data[0];
                        
                        // 3. BLINDAGEM DE CIDADE
                        const addrProps = item.address || {};
                        const city = addrProps.city || addrProps.town || addrProps.municipality || addrProps.village || "";
                        
                        if (!city.includes("Cascavel")) {
                            handleAddressError();
                            return;
                        }

                        const lat = parseFloat(item.lat);
                        const lon = parseFloat(item.lon);
                        calculateDistance(lat, lon, 'mapa_texto');
                    } else {
                        handleAddressError();
                    }
                } catch(e) {
                    console.error(e);
                    handleAddressError();
                }
            };

            const calculateDistance = async (lat, lon, sourceMethod) => {
                try {
                    const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${RESTAURANT_COORDS.lng},${RESTAURANT_COORDS.lat};${lon},${lat}?overview=false`;
                    const rRes = await fetch(osrmUrl);
                    const rData = await rRes.json();

                    if (rData.routes && rData.routes.length > 0) {
                        const meters = rData.routes[0].distance;
                        const km = (meters / 1000).toFixed(1);
                        const fee = Math.max(5, km * settings.pricePerKm);
                        setDel({ fee, km, loading: false, lat, lon, method: sourceMethod });
                    } else {
                        fallbackCalc(lat, lon, sourceMethod);
                    }
                } catch(e) {
                    fallbackCalc(lat, lon, sourceMethod);
                }
            };

            const fallbackCalc = (lat, lon, sourceMethod) => {
                const R=6371; 
                const dLat=(lat-RESTAURANT_COORDS.lat)*Math.PI/180; 
                const dLon=(lon-RESTAURANT_COORDS.lng)*Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(RESTAURANT_COORDS.lat*Math.PI/180)*Math.cos(lat*Math.PI/180) * Math.sin(dLon/2)*Math.sin(dLon/2);
                const km = (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)) * 1.3).toFixed(1);
                const fee = Math.max(5, km * settings.pricePerKm);
                setDel({ fee, km, loading: false, lat, lon, method: sourceMethod });
            };

            const handleCouponChange = (e) => {
                const cleanCode = e.target.value.replace(/\s/g, '').toUpperCase();
                setCouponCode(cleanCode);
            };

            const applyCoupon = async () => {
                if(!couponCode) return;
                const q = await getCol('coupons').where('code', '==', couponCode).where('active', '==', true).get();
                if(q.empty) return alert("Cupom inv√°lido!");
                const coup = { id: q.docs[0].id, ...q.docs[0].data() };
                const limit = parseInt(coup.limit || 0);
                const usage = parseInt(coup.usageCount || 0);
                if(usage >= limit) return alert("Cupom esgotado!");
                if(coup.type === 'item') {
                    const prod = products.find(p => p.id === coup.value);
                    if(prod) { setCart(prev => [...prev, { ...prod, price: 0, isBonus: true, quantity: 1 }]); alert(`Item Gr√°tis Adicionado: ${prod.name}`); }
                }
                setAppliedCoupon(coup); setCouponCode("");
            };

            const getDiscountVal = () => {
                if(!appliedCoupon) return 0;
                if(appliedCoupon.type === 'fixed') return parseFloat(appliedCoupon.value);
                if(appliedCoupon.type === 'percent') {
                    let val = total * (parseFloat(appliedCoupon.value)/100);
                    if(appliedCoupon.maxDiscount && val > parseFloat(appliedCoupon.maxDiscount)) val = parseFloat(appliedCoupon.maxDiscount);
                    return val;
                }
                return 0;
            };

            const finalTotal = Math.max(0, total - getDiscountVal() + del.fee);

            const finish = async () => {
                if(!form.name || !form.phone || !form.address || !form.bairro || !payMethod) return alert("Preencha todos os campos obrigat√≥rios!");
                // Bloqueia se frete n√£o foi calculado
                if(del.fee === 0 && del.method !== 'bairro_fixo') return alert("Aguarde o c√°lculo do frete ou corrija o endere√ßo.");

                try {
                    const batch = db.batch();
                    const clean = form.phone.replace(/\D/g,'');
                    batch.set(getCol('orders').doc(), {
                        customer: form, items: cart,
                        totals: { sub: total, del: del.fee, discount: getDiscountVal(), total: finalTotal },
                        payment: { method: payMethod, change: change },
                        coupon: appliedCoupon ? appliedCoupon.code : null,
                        location: { lat: del.lat, lon: del.lon, method: del.method },
                        createdAt: new Date().toISOString(), status: 'pendente'
                    });
                    const cRef = getCol('customers');
                    const cSnap = await cRef.where('phoneRaw','==',clean).limit(1).get();
                    if(cSnap.empty) batch.set(cRef.doc(), {...form, phoneRaw:clean, lastOrder:new Date().toISOString(), orderCount:1});
                    else batch.update(cSnap.docs[0].ref, {...form, lastOrder:new Date().toISOString(), orderCount: firebase.firestore.FieldValue.increment(1)});
                    if(appliedCoupon) batch.update(getCol('coupons').doc(appliedCoupon.id), { usageCount: firebase.firestore.FieldValue.increment(1) });
                    
                    await batch.commit();
                    
                    localStorage.removeItem('fritzza_cart');

                    let msg = `*PEDIDO FRITZZA*\nüë§ ${form.name}\nüìû ${form.phone}\nüìç ${form.address}, ${form.bairro}\n${form.complement ? `(${form.complement})` : ''}\n\nüõí *ITENS:*\n${cart.map(i=>`${i.quantity}x ${i.name} ${i.isBonus?'(GR√ÅTIS)':''}`).join('\n')}\n\nüí∞ Pgto: ${payMethod} ${change?`(Troco: ${change})`:''}`;
                    if(appliedCoupon) msg += `\nüéüÔ∏è Cupom: ${appliedCoupon.code}`;
                    msg += `\nüõµ Entrega: ${formatMoney(del.fee)}`;
                    if(del.lat) msg += `\nüó∫Ô∏è *Maps:* https://maps.google.com/?q=${del.lat},${del.lon}`;
                    msg += `\n‚úÖ *TOTAL: ${formatMoney(finalTotal)}*`;
                    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`);
                    onClear(); onBack();
                } catch(e) { alert("Erro: "+e.message); }
            };

            return (
                <div className="bg-white rounded-xl shadow p-4 min-h-screen">
                    <div className="flex items-center gap-2 mb-4 font-bold border-b pb-2" style={text}><button onClick={onBack}><i className="fa-solid fa-arrow-left"></i></button><h2>Checkout</h2></div>
                    
                    {/* RESUMO PEDIDO */}
                    <div className="mb-6 border-b pb-4">
                        <h3 className="font-bold text-gray-700 mb-3">Seu Pedido</h3>
                        {cart.map(i => (
                            <div key={i.id} className="flex justify-between py-1 text-sm">
                                <span className="text-gray-600">{i.quantity}x {i.name} {i.isBonus && <b className="text-green-600">GR√ÅTIS</b>}</span>
                                <span className="font-medium">{formatMoney(i.price * i.quantity)}</span>
                            </div>
                        ))}
                        <div className="flex justify-between font-bold text-lg mt-2 pt-2 border-t text-gray-800"><span>Subtotal</span><span>{formatMoney(total)}</span></div>
                    </div>

                    {/* FORMUL√ÅRIO */}
                    <div className="space-y-4">
                        <div className="space-y-2">
                            <h3 className="font-bold text-gray-700 border-b pb-1">Dados de Entrega</h3>
                            
                            <input placeholder="WhatsApp (45...)" className="w-full border p-3 rounded bg-gray-50" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} onBlur={check} />
                            <input placeholder="Nome" className="w-full border p-3 rounded bg-gray-50" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />
                            
                            <div className="relative">
                                <input placeholder="Endere√ßo (Rua e N¬∫)" className="w-full border p-3 rounded bg-gray-50 pr-10" value={form.address} onChange={e=>setForm({...form, address:e.target.value})} />
                                {del.loading && <i className="fa-solid fa-spinner fa-spin absolute right-3 top-3 text-gray-400"></i>}
                            </div>
                            
                            <input list="bairros-list" placeholder="Bairro" className="w-full border p-3 rounded bg-gray-50" value={form.bairro} onChange={e=>setForm({...form, bairro:e.target.value})} />
                            <datalist id="bairros-list">{neighborhoods.map(n => <option key={n.id} value={n.name} />)}</datalist>
                            <p className="text-xs text-gray-400 ml-1">*O sistema calcular√° o frete automaticamente.</p>
                            
                            <input placeholder="Complemento (Opcional)" className="w-full border p-3 rounded bg-gray-50" value={form.complement} onChange={e=>setForm({...form, complement:e.target.value})} />
                        </div>

                        <div className="space-y-2">
                            <h3 className="font-bold text-gray-700 border-b pb-1">Pagamento</h3>
                            <div className="grid grid-cols-2 gap-2">{['Dinheiro','Pix','Cart√£o Cr√©dito','Cart√£o D√©bito'].map(m=><button key={m} onClick={()=>setPayMethod(m)} className={`p-2 rounded text-sm border ${payMethod===m?'text-white':'text-gray-600'}`} style={payMethod===m?theme:{}}>{m}</button>)}</div>
                            {payMethod==='Dinheiro'&&<input type="number" placeholder="Troco para?" className="w-full border p-2 rounded bg-yellow-50" value={change} onChange={e=>setChange(e.target.value)}/>}
                            {payMethod==='Pix'&&<div className="text-xs text-blue-600 bg-blue-50 p-2 rounded">Chave Pix ser√° enviada na mensagem.</div>}
                        </div>

                        {/* TOTAIS E CUPOM */}
                        <div className="bg-gray-100 p-3 rounded border">
                            <div className="flex justify-between text-sm">
                                <span>Entrega {del.method==='gps_auto'?'(Via GPS)':del.method==='mapa_texto'?'(Endere√ßo)':''} ({del.km}km)</span>
                                <span className={del.method==='gps_auto'?'text-green-600 font-bold':''}>{del.loading ? 'Calculando...' : formatMoney(del.fee)}</span>
                            </div>

                            {appliedCoupon ? (
                                <div className="flex justify-between text-sm text-green-600 font-bold animate-fade-in border-t pt-2 mt-2">
                                    <span>Cupom: {appliedCoupon.code}</span>
                                    <span>- {formatMoney(getDiscountVal())}</span>
                                </div>
                            ) : (
                                <div className="mt-2 border-t pt-2">
                                    <label className="text-xs font-bold text-gray-500">CUPOM DE DESCONTO:</label>
                                    <div className="flex gap-2 mt-1">
                                        <input placeholder="C√ìDIGO" className="border p-2 rounded text-sm w-full uppercase bg-white" value={couponCode} onChange={handleCouponChange} />
                                        <button onClick={applyCoupon} className="text-white text-xs px-4 rounded font-bold" style={theme}>APLICAR</button>
                                    </div>
                                </div>
                            )}

                            <div className="flex justify-between font-bold text-xl mt-2 border-t pt-2" style={text}><span>Total Final</span><span>{formatMoney(finalTotal)}</span></div>
                        </div>
                        
                        <button onClick={finish} disabled={del.loading} className="w-full text-white py-4 rounded font-bold shadow text-lg flex justify-center gap-2 disabled:opacity-50" style={theme}><span>Enviar Pedido</span><i className="fa-brands fa-whatsapp"></i></button>
                    </div>
                </div>
            );
        };

        // --- ADMIN (Mantido) ---
        const AdminLogin = ({onLogin, onCancel, theme}) => { const [p,setP]=useState(""); return <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"><div className="bg-white p-6 rounded-lg w-full max-w-sm"><h3 className="font-bold mb-4">Admin</h3><input type="password" placeholder="Senha" className="w-full border p-2 mb-4 rounded" value={p} onChange={e=>setP(e.target.value)}/><div className="flex justify-end gap-2"><button onClick={onCancel}>Cancelar</button><button onClick={()=>p==="admin"?onLogin():alert("Erro")} className="text-white px-4 py-2 rounded" style={theme}>Entrar</button></div></div></div> };
        const AdminPanel = ({ products, categories, settings, neighborhoods, theme }) => { const [tab, setTab] = useState("produtos"); return (<div className="bg-white p-4 rounded shadow min-h-screen"><h2 className="font-bold text-xl mb-4">Admin</h2><div className="flex gap-2 mb-4 overflow-x-auto">{["produtos","cupons","bairros","pedidos","clientes","config"].map(t=><button key={t} onClick={()=>setTab(t)} className={`px-3 py-1 rounded capitalize ${tab===t?'text-white':'bg-gray-100'}`} style={tab===t?theme:{}}>{t}</button>)}</div>{tab==="produtos" && <AdminProducts products={products} categories={categories} theme={theme} />}{tab==="cupons" && <AdminCoupons products={products} theme={theme} />}{tab==="bairros" && <AdminNeighborhoods neighborhoods={neighborhoods} theme={theme} />}{tab==="pedidos" && <AdminOrders />}{tab==="clientes" && <AdminCustomers />}{tab==="config" && <AdminConfig settings={settings} categories={categories} theme={theme} />}</div>); };
        const AdminNeighborhoods = ({ neighborhoods, theme }) => { const [data, setData] = useState({ name: "", price: "" }); const save = async (e) => { e.preventDefault(); if(!data.name || !data.price) return; await getCol('neighborhoods').add({...data, price: parseFloat(data.price)}); setData({name:"", price:""}); }; const del = async (id) => confirm("Apagar?") && await getCol('neighborhoods').doc(id).delete(); return <div><form onSubmit={save} className="bg-gray-50 p-3 rounded mb-3 flex gap-2"><input placeholder="Nome do Bairro (ex: Centro)" className="border p-2 flex-1 rounded" value={data.name} onChange={e=>setData({...data, name:e.target.value})} /><input type="number" placeholder="Pre√ßo (10.00)" className="border p-2 w-24 rounded" value={data.price} onChange={e=>setData({...data, price:e.target.value})} /><button className="text-white px-4 rounded font-bold" style={theme}>Add</button></form><div className="space-y-2">{neighborhoods.map(n=><div key={n.id} className="flex justify-between border p-2 rounded bg-white"><span>{n.name}</span><span>{formatMoney(n.price)} <button onClick={()=>del(n.id)} className="text-red-500 ml-2">X</button></span></div>)}</div></div> };
        const AdminCoupons = ({ products, theme }) => { const [coupons, setCoupons] = useState([]); const [form, setForm] = useState({ code: "", type: "fixed", value: "", limit: 100, maxDiscount: "" }); useEffect(() => { const u = getCol('coupons').onSnapshot(s => setCoupons(s.docs.map(d => ({ id: d.id, ...d.data() })))); return () => u(); }, []); const save = async (e) => { e.preventDefault(); if(!form.code || !form.value) return alert("Preencha tudo"); const payload = { ...form, code: form.code.toUpperCase(), usageCount: 0, active: true, createdAt: new Date().toISOString() }; if(form.type !== 'percent') delete payload.maxDiscount; else if(form.maxDiscount) payload.maxDiscount = parseFloat(form.maxDiscount); await getCol('coupons').add(payload); setForm({ code: "", type: "fixed", value: "", limit: 100, maxDiscount: "" }); }; const del = async (id) => confirm("Apagar cupom?") && await getCol('coupons').doc(id).delete(); return (<div><form onSubmit={save} className="bg-gray-50 p-3 rounded mb-4 border space-y-2"><h3 className="font-bold">Novo Cupom</h3><div className="flex gap-2"><input placeholder="C√≥digo" className="border p-2 rounded w-1/2 uppercase" value={form.code} onChange={e=>setForm({...form, code:e.target.value})} /><input type="number" placeholder="Limite" className="border p-2 rounded w-1/2" value={form.limit} onChange={e=>setForm({...form, limit:parseInt(e.target.value)})} /></div><div className="flex gap-2 flex-wrap"><select className="border p-2 rounded w-1/3" value={form.type} onChange={e=>setForm({...form, type:e.target.value})}><option value="fixed">R$</option><option value="percent">%</option><option value="item">Item</option></select>{form.type === 'item' ? (<select className="border p-2 rounded flex-1" value={form.value} onChange={e=>setForm({...form, value:e.target.value})}><option value="">Produto...</option>{products.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}</select>) : (<input type="number" placeholder={form.type==='percent'?"10, 20...":"10.00"} className="border p-2 rounded flex-1" value={form.value} onChange={e=>setForm({...form, value:e.target.value})} />)}{form.type === 'percent' && (<input type="number" placeholder="Teto M√°x R$" className="border p-2 rounded w-full" value={form.maxDiscount} onChange={e=>setForm({...form, maxDiscount:e.target.value})} />)}</div><button className="w-full text-white py-2 rounded font-bold" style={theme}>Criar Cupom</button></form><div className="space-y-2">{coupons.map(c => (<div key={c.id} className="flex justify-between items-center border p-2 rounded bg-white"><div><b className="text-green-700">{c.code}</b> <span className="text-xs ml-2 bg-gray-200 px-1 rounded">{c.type === 'item' ? 'Item' : c.type==='percent' ? `${c.value}%` : `R$ ${c.value}`}</span></div><button onClick={()=>del(c.id)} className="text-red-500 px-2">X</button></div>))}</div></div>); };
        const AdminProducts = ({products, categories, theme}) => { const [edit, setEdit] = useState(false); const [data, setData] = useState({name:"", price:"", category:"", imageUrl:"", description:""}); const save = async (e) => { e.preventDefault(); const p = {...data, price:parseFloat(data.price)}; if(data.id) await getCol('products').doc(data.id).update(p); else await getCol('products').add(p); setEdit(false); setData({name:"", price:"", category:"", imageUrl:"", description:""}); }; const del = async (id) => confirm("Excluir?") && await getCol('products').doc(id).delete(); return <div><button onClick={()=>{setData({name:"", price:"", category:categories[0]?.name||"", imageUrl:"", description:""}); setEdit(true)}} className="text-white px-3 py-2 rounded mb-3 font-bold" style={theme}>+ Produto</button>{edit && <form onSubmit={save} className="bg-gray-100 p-3 rounded mb-3 space-y-2"><input required placeholder="Nome" className="w-full border p-2" value={data.name} onChange={e=>setData({...data, name:e.target.value})} /><div className="flex gap-2"><input type="number" step="0.01" className="w-1/2 border p-2" value={data.price} onChange={e=>setData({...data, price:e.target.value})} /><select className="w-1/2 border p-2" value={data.category} onChange={e=>setData({...data, category:e.target.value})}>{categories.map(c=><option key={c.id} value={c.name}>{c.name}</option>)}</select></div><input placeholder="URL Imagem" className="w-full border p-2" value={data.imageUrl} onChange={e=>setData({...data, imageUrl:e.target.value})} /><textarea placeholder="Desc" className="w-full border p-2" value={data.description} onChange={e=>setData({...data, description:e.target.value})} /><button className="w-full text-white py-2 rounded" style={theme}>Salvar</button></form>}<div className="space-y-2">{products.map(p=><div key={p.id} className="flex justify-between border p-2 rounded bg-white"><div><b>{p.name}</b><br/><span className="text-xs">{formatMoney(p.price)}</span></div><button onClick={()=>del(p.id)} className="text-red-500">X</button></div>)}</div></div>; };
        const AdminOrders = () => { const [o, setO] = useState([]); useEffect(() => { const u = getCol('orders').orderBy('createdAt', 'desc').limit(20).onSnapshot(s => setO(s.docs.map(d => ({ id: d.id, ...d.data() })))); return () => u(); }, []); return <div className="space-y-3">{o.map(x => <div key={x.id} className="border p-3 rounded bg-white"><div className="flex justify-between"><b>{x.customer.name}</b> <b>{formatMoney(x.totals.total)}</b></div><div className="text-xs text-gray-500">{new Date(x.createdAt).toLocaleString()} {x.coupon && <span className="text-green-600 ml-2">Cupom: {x.coupon}</span>}</div></div>)}</div>; };
        const AdminCustomers = () => { const [all, setAll] = useState([]); const [filter, setFilter] = useState("all"); useEffect(() => { const u = getCol('customers').limit(2000).onSnapshot(s => setAll(s.docs.map(d => ({ id: d.id, ...d.data() })))); return () => u(); }, []); const filtered = useMemo(() => { let list = [...all]; if (filter === "top") return list.filter(c => (c.orderCount || 0) >= 2).sort((a, b) => (b.orderCount || 0) - (a.orderCount || 0)).slice(0, 50); if (filter === "recent") return list.sort((a, b) => new Date(b.lastOrder) - new Date(a.lastOrder)).slice(0, 100); if (filter === "inactive") { const d = new Date(); d.setDate(d.getDate() - 30); return list.filter(c => new Date(c.lastOrder) < d); } return list.sort((a, b) => new Date(b.lastOrder) - new Date(a.lastOrder)); }, [all, filter]); const exp = () => { const t = "Nome;Tel;End\n" + filtered.map(x => `${x.name};${x.phone};${x.address}`).join('\n'); const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURI("\uFEFF"+t); a.download = `clientes_${filter}.csv`; a.click(); }; return <div><div className="flex flex-wrap gap-2 mb-4 bg-gray-50 p-2 rounded"><button onClick={()=>setFilter("all")} className={`px-3 py-1 rounded text-sm font-bold ${filter==="all"?"bg-red-600 text-white":"bg-white border"}`}>Todos</button><button onClick={()=>setFilter("top")} className={`px-3 py-1 rounded text-sm font-bold ${filter==="top"?"bg-red-600 text-white":"bg-white border"}`}>Top 50</button><button onClick={()=>setFilter("recent100")} className={`px-3 py-1 rounded text-sm font-bold ${filter==="recent100"?"bg-red-600 text-white":"bg-white border"}`}>√öltimos 100</button><button onClick={()=>setFilter("inactive")} className={`px-3 py-1 rounded text-sm font-bold ${filter==="inactive"?"bg-red-600 text-white":"bg-white border"}`}>Inativos 30d</button></div><button onClick={exp} className="bg-green-600 text-white px-2 py-1 rounded mb-2">Exportar</button><div className="h-64 overflow-y-auto space-y-2">{filtered.map(x=><div key={x.id} className="border p-2 text-sm bg-white"><b>{x.name}</b> ({x.orderCount||1}x)<br/>{x.phone}</div>)}</div></div>; };
        const AdminConfig = ({ settings, categories, theme }) => { const [km, setKm] = useState(settings.pricePerKm); const [color, setColor] = useState(settings.themeColor || "#dc2626"); const [logo, setLogo] = useState(settings.logoUrl || ""); const [nC, setNC] = useState(""); const saveMain = () => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('config').doc('main').set({ pricePerKm: parseFloat(km), themeColor: color, logoUrl: logo }, { merge: true }); const addC = () => { if(nC) getCol('categories').add({ name: nC, order: categories.length }); setNC(""); }; const delC = (id) => confirm("Excluir?") && getCol('categories').doc(id).delete(); const move = (idx, dir) => { if((dir===-1&&idx===0)||(dir===1&&idx===categories.length-1))return; const items = [...categories]; const temp = items[idx]; items[idx] = items[idx+dir]; items[idx+dir] = temp; const b = db.batch(); items.forEach((cat, i) => { b.update(getCol('categories').doc(cat.id), {order: i}); }); b.commit(); }; return (<div className="space-y-4"><div className="border p-3 rounded bg-white space-y-3"><h3 className="font-bold">Config Geral</h3><div className="flex gap-2 items-center"><label>Cor:</label><input type="color" value={color} onChange={e=>setColor(e.target.value)} className="h-8 w-16 cursor-pointer"/></div><div><label className="block text-sm">URL Logo:</label><input className="border w-full p-1 rounded" value={logo} onChange={e=>setLogo(e.target.value)} placeholder="https://..." /></div><div className="flex gap-2 items-center"><label>R$ / Km (Base):</label><input type="number" className="border w-16 p-1 rounded" value={km} onChange={e=>setKm(e.target.value)} /></div><button onClick={saveMain} className="text-white px-4 py-2 rounded w-full font-bold" style={theme}>Salvar</button></div><div className="border p-3 rounded bg-white"><h3>Categorias</h3><div className="flex gap-2 mb-2"><input className="border p-1 flex-1" value={nC} onChange={e=>setNC(e.target.value)} /><button onClick={addC} className="text-white px-2 rounded" style={theme}>+</button></div>{categories.map((c,i)=><div key={c.id} className="flex justify-between border-b py-1"><span>{c.name}</span><div className="flex gap-1"><button onClick={()=>move(i,-1)}>‚¨ÜÔ∏è</button><button onClick={()=>move(i,1)}>‚¨áÔ∏è</button><button onClick={()=>delC(c.id)} className="text-red-500">x</button></div></div>)}</div></div>); };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


