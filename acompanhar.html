<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhar Pedido - Fritzza</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Chewy&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .font-chewy { font-family: 'Chewy', cursive; }
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Timeline Animations */
        .step-line { position: absolute; left: 24px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; z-index: 0; }
        .step-item { position: relative; z-index: 1; }
        .moto-anim { animation: driveDown 1s ease-out forwards; }
        @keyframes driveDown { from { top: -20px; opacity: 0; } to { top: 0; opacity: 1; } }
        
        /* Order List Card Animation */
        .order-card-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURAÇÃO FIREBASE (MESMA DO CLIENTE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAg2kfoWsvWWyEXQGe8v6jZZqKepgButUk",
            authDomain: "ajuda-2217b.firebaseapp.com",
            projectId: "ajuda-2217b",
            storageBucket: "ajuda-2217b.firebasestorage.app",
            messagingSenderId: "421083897636",
            appId: "1:421083897636:web:18bd6097b5c0169427ddb1"
        };

        if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) {} }
        const db = firebase.firestore();
        const APP_ID = "ajuda-2217b"; 
        const getCol = (n) => db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection(n);

        const { useState, useEffect, useMemo } = React;
        const formatMoney = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const WHATSAPP_NUMBER = "5545988166885";

        const App = () => {
            const [allOrders, setAllOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [loading, setLoading] = useState(true);
            const [phoneInput, setPhoneInput] = useState("");
            const [error, setError] = useState("");
            const [settings, setSettings] = useState({});

            useEffect(() => {
                // Carrega config para pegar cores e nome
                db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('config').doc('main').onSnapshot(d => { 
                    if (d.exists) { 
                        setSettings(d.data()); 
                        if(d.data().bgColor) document.body.style.backgroundColor = d.data().bgColor; 
                    }
                });

                // Tenta pegar telefone da URL
                const urlParams = new URLSearchParams(window.location.search);
                const phone = urlParams.get('fone');
                
                if (phone) {
                    loadOrders(phone);
                } else {
                    setLoading(false);
                }
            }, []);

            const loadOrders = (phone) => {
                setLoading(true);
                const cleanPhone = phone.replace(/\D/g, '');
                
                // Busca TODOS os pedidos desse telefone (Ordenação via Client-Side para evitar erro de index composto)
                getCol('orders').where('customer.phone', '==', cleanPhone).limit(50).onSnapshot(snap => {
                    if (snap.empty) {
                        setError("Nenhum pedido encontrado para este número.");
                        setLoading(false);
                        return;
                    }
                    
                    const orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    // Ordena por data decrescente (mais novo primeiro)
                    orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    setAllOrders(orders);
                    
                    // Se já tinha um selecionado, tenta mantê-lo atualizado, senão pega o primeiro
                    setSelectedOrder(prev => {
                        if (prev) {
                            const stillExists = orders.find(o => o.id === prev.id);
                            return stillExists || orders[0];
                        }
                        return orders[0];
                    });
                    
                    setLoading(false);
                }, err => {
                    console.error(err);
                    setError("Erro ao buscar pedidos.");
                    setLoading(false);
                });
            };

            const handleSearch = (e) => {
                e.preventDefault();
                if(phoneInput.length < 8) return;
                const clean = phoneInput.replace(/\D/g,'');
                window.history.pushState({}, '', '?fone=' + clean);
                loadOrders(clean);
            };

            const themeStyle = { backgroundColor: settings.themeColor || '#dc2626' };
            const borderStyle = settings.borderRadius || 'rounded-2xl';

            if (loading) return <div className="h-screen flex flex-col items-center justify-center text-gray-400"><div className="loader border-gray-400 border-b-transparent mb-4"></div><p>Buscando pedidos...</p></div>;

            // TELA DE LOGIN (DIGITAR TELEFONE)
            if (allOrders.length === 0 && !loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className={`bg-white p-8 shadow-xl max-w-sm w-full text-center ${borderStyle}`}>
                            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-gray-400"><i className="fa-solid fa-search"></i></div>
                            <h2 className="text-xl font-bold text-gray-800 mb-2">Meus Pedidos</h2>
                            <p className="text-sm text-gray-500 mb-6">Digite seu celular (WhatsApp) para listar seus pedidos.</p>
                            <form onSubmit={handleSearch}>
                                <input type="tel" placeholder="Seu Celular (45...)" className={`w-full border p-3 bg-gray-50 text-center text-lg font-bold mb-4 ${borderStyle}`} value={phoneInput} onChange={e=>setPhoneInput(e.target.value)} autoFocus />
                                <button className={`w-full text-white py-3 font-bold shadow-lg ${borderStyle}`} style={themeStyle}>Buscar</button>
                            </form>
                            {error && <div className="mt-4 text-red-500 text-sm bg-red-50 p-2 rounded">{error}</div>}
                            <a href="cliente.html" className="block mt-6 text-sm text-gray-400 underline">Voltar para Cardápio</a>
                        </div>
                    </div>
                );
            }

            const steps = [
                { s: 'pendente', label: 'Recebido', icon: 'fa-file-invoice' }, 
                { s: 'confirmado', label: 'Confirmado', icon: 'fa-thumbs-up' }, 
                { s: 'preparando', label: 'Preparando', icon: 'fa-fire-burner' }, 
                { s: 'enviado', label: 'Saiu p/ Entrega', icon: 'fa-motorcycle' }, 
                { s: 'entregue', label: 'Entregue', icon: 'fa-house-circle-check' }
            ];
            
            // Garantir que order não seja nulo antes de renderizar
            if (!selectedOrder) return null;

            const currentIdx = steps.findIndex(st => st.s === selectedOrder.status) || 0;
            const progress = (currentIdx / (steps.length - 1)) * 100;

            return (
                <div className="min-h-screen pb-10 flex flex-col md:flex-row gap-6 max-w-6xl mx-auto p-4 md:p-8">
                    
                    {/* COLUNA DA ESQUERDA: PEDIDO EM DESTAQUE */}
                    <div className="flex-1">
                        <div className="flex items-center gap-2 mb-4">
                            <button onClick={()=>window.location.href='cliente.html'} className="text-gray-500 hover:text-gray-800"><i className="fa-solid fa-arrow-left"></i> Voltar</button>
                            <h2 className="text-xl font-bold text-gray-800">Acompanhamento</h2>
                        </div>

                        <div className={`bg-white shadow-xl overflow-hidden mb-6 relative ${borderStyle}`}>
                            {/* Header Status */}
                            <div className="p-8 text-center text-white relative overflow-hidden" style={themeStyle}>
                                <div className="absolute inset-0 bg-black/10"></div>
                                <div className="relative z-10">
                                    <div className="text-sm opacity-80 mb-2">PEDIDO #{selectedOrder.id.slice(-4)}</div>
                                    <h2 className="text-3xl font-chewy mb-2 animate-pulse">{steps[currentIdx].label}</h2>
                                    <p className="text-sm opacity-90">{new Date(selectedOrder.createdAt).toLocaleString()}</p>
                                </div>
                            </div>

                            {/* Timeline */}
                            <div className="p-8 bg-gray-50">
                                <div className="relative pl-8 space-y-8">
                                    <div className="step-line absolute left-[15px] top-2 bottom-2 w-1 bg-gray-200"></div>
                                    <div className="step-line absolute left-[15px] top-2 w-1 transition-all duration-1000" style={{height: `${progress}%`, ...themeStyle}}>
                                        <div className="absolute -bottom-3 -left-3 bg-white p-1 rounded-full shadow-sm border moto-anim" style={{borderColor: settings.themeColor}}>
                                            <i className="fa-solid fa-motorcycle text-sm" style={{color: settings.themeColor}}></i>
                                        </div>
                                    </div>
                                    {steps.map((st, i) => { 
                                        const active = i <= currentIdx; 
                                        return (
                                            <div key={st.s} className={`step-item flex items-center gap-4 ${active ? 'opacity-100' : 'opacity-40 grayscale'}`}>
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white z-10 shadow-md transition-all duration-500 ${active ? 'scale-110' : 'scale-100 bg-gray-300'}`} style={active ? themeStyle : {}}>
                                                    <i className={`fa-solid ${st.icon} text-xs`}></i>
                                                </div>
                                                <div className="font-bold text-gray-800">{st.label}</div>
                                            </div>
                                        ); 
                                    })}
                                </div>
                            </div>
                            
                            {/* Resumo */}
                            <div className="p-6 border-t bg-white">
                                <h4 className="font-bold text-gray-800 mb-3 border-b pb-2">Itens do Pedido</h4>
                                <div className="text-sm text-gray-600 space-y-2 mb-4">
                                    {selectedOrder.items.map((item, idx) => (
                                        <div key={idx} className="flex justify-between">
                                            <span>{item.quantity}x {item.name}</span>
                                            <span className="font-bold">{formatMoney(item.price * item.quantity)}</span>
                                        </div>
                                    ))}
                                    <div className="flex justify-between border-t border-gray-300 pt-2 mt-2 font-bold text-xl text-gray-800">
                                        <span>Total</span>
                                        <span>{formatMoney(selectedOrder.totals.total)}</span>
                                    </div>
                                </div>
                                <div className="bg-blue-50 p-3 rounded text-xs text-blue-800 mb-4 flex items-start gap-2">
                                    <i className="fa-solid fa-location-dot mt-1"></i>
                                    <div><b>Entrega em:</b> {selectedOrder.customer.address}, {selectedOrder.customer.number} - {selectedOrder.customer.bairro}</div>
                                </div>
                                <button onClick={()=>window.open(`https://wa.me/${WHATSAPP_NUMBER}`, '_blank')} className="w-full py-3 bg-green-500 text-white font-bold rounded-xl shadow-md flex items-center justify-center gap-2 hover:bg-green-600 transition">
                                    <i className="fa-brands fa-whatsapp"></i> Falar com o Restaurante
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* COLUNA DA DIREITA: LISTA DE OUTROS PEDIDOS */}
                    <div className="md:w-80 w-full">
                        <h3 className="font-bold text-gray-800 mb-4 text-lg">Seus Pedidos ({allOrders.length})</h3>
                        <div className="space-y-3">
                            {allOrders.map(order => (
                                <div 
                                    key={order.id} 
                                    onClick={() => { setSelectedOrder(order); window.scrollTo({top:0, behavior:'smooth'}); }}
                                    className={`p-4 rounded-xl cursor-pointer border transition hover:shadow-md order-card-enter ${selectedOrder.id === order.id ? 'bg-white border-l-4 shadow-md' : 'bg-white/60 border-transparent hover:bg-white'}`}
                                    style={selectedOrder.id === order.id ? {borderLeftColor: settings.themeColor} : {}}
                                >
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="font-bold text-gray-800">#{order.id.slice(-4)}</span>
                                        <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded ${order.status==='pendente'?'bg-red-100 text-red-700':order.status==='entregue'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700'}`}>
                                            {order.status}
                                        </span>
                                    </div>
                                    <div className="text-xs text-gray-500 mb-2">
                                        <i className="fa-regular fa-calendar mr-1"></i>
                                        {new Date(order.createdAt).toLocaleDateString()} às {new Date(order.createdAt).toLocaleTimeString().slice(0,5)}
                                    </div>
                                    <div className="flex justify-between items-end">
                                        <span className="text-xs text-gray-600">{order.items.length} itens</span>
                                        <span className="font-bold text-gray-800">{formatMoney(order.totals.total)}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


